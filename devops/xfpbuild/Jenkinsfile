/*
 * ##################################################################################
 * #
 * XFP internal build pipeline
 * should run fast (<10min) with following parts
 * - unit test and report
 * - SonarQube report
 * - compilation (if for more than one framework, than in parallel)
 * - doxygen build and deploy on internal server
 *
 */

pipeline {
	/**
	 * node where to run on (try itec on the TCP Jenkins)
	 */
	agent {
		node {
			label 'itec'
		}
	}

	/**
	 * Keep only the last 5 artifacts on the server to prevent from
	 * locking massive amount of diskspace. The number should <= 5.
	 */
	options {
		buildDiscarder(
			logRotator(
				numToKeepStr: '5',
				artifactNumToKeepStr: '5'
			)
		)
		disableConcurrentBuilds()
	}

	/**
	 * Set up cron triggers for constant pipeline builds if this is needed
	 */
	/*
	triggers {
		cron('H H(0-1) * * *')
	}
	*/

	stages {
		stage('Build documentation') {
			parallel {
				/*-----------------------------------------------------------------------------
				 * html
				 *-----------------------------------------------------------------------------
				 */
				stage('HTML') {
					steps {
						echo "html"
						//sh ("export DOXY_BIN_PATH=/usr/local/bin/;cd ${env.WORKSPACE}/docs;/usr/bin/make html")
					}
				}
				/*-----------------------------------------------------------------------------
				 * latex/pdf
				 *-----------------------------------------------------------------------------
				 */
				stage('PDF') {
					steps {
						echo "latex/pdf"
						/*
						sh ("export DOXY_BIN_PATH=/usr/local/bin/;cd ${env.WORKSPACE}/docs;/usr/bin/make pdf")
						build(
							job: 'dev/doxy_maker_pdf',
							propagate: true,
							parameters: [
								[
									$class: 'StringParameterValue',
									name: 'WORKSPACE',
									value: "${env.WORKSPACE}"
								],
							]
						)
						*/
					}
				}
			} // end parallel
		} // end docu build

		stage('Check') {
			parallel {

				/*-----------------------------------------------------------------------------
				 * cppcheck
				 *-----------------------------------------------------------------------------
				 */
				stage('CPP') {
					steps {
						echo "cpp"
						//sh "cd  ${env.WORKSPACE};mkdir -p build;/usr/local/bin/cppcheck -v --enable=all --xml-version=2 -I examples src 2> build/cppcheck-report.xml"
					} // end steps
				} // end stage

				/*-----------------------------------------------------------------------------
				 * cppcheck
				 *-----------------------------------------------------------------------------
				 */
				stage('CLI') {
					steps {
						echo "Compile"
						//sh ("cd ${env.WORKSPACE};/usr/bin/make all")
					} // end steps
				} // end stage

			} // parallel
		} // end stage

		stage('SonarQube') {
			environment {
				scannerHome = tool 'SonarQubeScanner'
			}
			steps {
				withSonarQubeEnv('SonarQube') {
					sh "${scannerHome}/bin/sonar-scanner -X"
				}
				catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
					timeout(time: 10, unit: 'MINUTES') {
						waitForQualityGate abortPipeline: true
					}
				}
			} // end steps
		} // end stage

		stage('Deploy') {
			parallel {
				/*-----------------------------------------------------------------------------
				 * development
				 *-----------------------------------------------------------------------------
				 */
				stage('Docu') {
					steps {
						echo "html deploy"
						//sh("mkdir -p /mnt/raspel/Public/doxygen/Tle94112/;cd ${env.WORKSPACE}/docs;cp -r html /mnt/raspel/Public/doxygen/Tle94112/;")
					}
				}


				/*-----------------------------------------------------------------------------
				 * production
				 *-----------------------------------------------------------------------------
				 */
				stage('PRODUCTION') {
					steps {
						echo "Production"
					}
				}

			} // end parallel
		} // end stage
	} // end stages

	/*-----------------------------------------------------------------------------
	 * post
	 *-----------------------------------------------------------------------------
	 */
	post {
		failure {
			/*
			mail(
				to: '',
				subject: "[EPE JENKINS] ${IFXLIB} pipeline:",
				body: "Something during Jenkins pipeline run went wrong."
			)
			*/
		}
	}

}
