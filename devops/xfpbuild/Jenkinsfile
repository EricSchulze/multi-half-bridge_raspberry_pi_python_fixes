/*
 * ##################################################################################
 *
 * XFP internal build pipeline
 * should run fast (<10min) with following parts
 * - unit test and report
 * - SonarQube report
 * - compilation (if for more than one framework, than in parallel)
 * - doxygen build and deploy on internal server
 *
 */
library("jenkins-pipeline-ifx-library")

def projectName = 'eden-artifactory-demo'
def artifactoryServer = 'Artifactory'
def artifactoryRepo = 'gen-des-epe-sw-development-local'
def artifactoryTarget = 'gen-des-tools-prod-eden-local'
def artifactorySW = 'https://artifactory.intra.infineon.com/artifactory/gen-des-epe-sw-development-local/'

def inoVER   = '0.18.3'
def inoCLI   = 'arduinoCLI/0.18.3'
def inoTGZ   = 'arduino-cli_0.18.3_Linux_64bit.tar.gz'
def inoBoard = 'arduinoBoardPackage/0.18.3/arduino-board-package_0.18.3_Linux_64bit.tar.gz'
def brdTGZ   = 'arduino-board-package_0.18.3_Linux_64bit.tar.gz'

def mtbVER   = '2.3.1'
def mtbTools = 'ModusToolbox/2.3.1'
def mtbTtgz  = 'ModusToolbox_tools_2.3.1_Linux_64bit.tar.gz'
def mtbmake  = 'ModusToolbox/tools_2.3/make/make'

def linuxTools = '/home/xfpjenki/tools'


pipeline {
	/**
	 * node where to run on
	 */
	agent {
		node {
			label 'epe'
		}
	}

	/**
	 * Parameter choice settings for manual start 
	 */
	parameters {
		choice(name: 'TIER',          choices:['development','staging','production'], description: 'tier setting')
		choice(name: 'SERVER',        choices:['vihlarazweb3','vihlarazweb2'],        description: 'server')
		choice(name: 'SONARINSTANCE', choices:['Sonar-Dev','Sonar-Prod'],             description: 'SonarQube instance')
		string(name: 'TESTBRANCH',    defaultValue: 'develop',                        description: 'e.g. DESMAKERS-990')
	}

	/**
	 * Environment settings for shell calls
	 */
	environment {
		TIER             = "${params.TIER}"
		WEB_ROOT         = "/home/razweb/htdocs-${params.SERVER}"
		REPO_NAME	     = "${GIT_URL.replaceFirst(/^.*\/([^\/]+?).git$/, '$1')}"
		DOCS_TARGET      = "${env.WEB_ROOT}/itec/xfp/${env.REPO_NAME}/${env.BRANCH_NAME}"
		DOCS_SOURCE      = "${env.WORKSPACE}/docs/doxygen/build"
		ROOT_URL         = "https://${params.SERVER}.vih.infineon.com"
		SONARINSTANCE    = "${params.SONARINSTANCE}"
	}

	/**
	 * Keep only the last 2 artifacts on the server to prevent from
	 * locking massive amount of disk space. The number should <= 5.
	 */
	options {
		buildDiscarder(
			logRotator(
				numToKeepStr: '2',
				artifactNumToKeepStr: '2'
			)
		)
		disableConcurrentBuilds()
	}

	/**
	 * Set up cron triggers for constant pipeline builds if this is needed
	 */
	/*
	triggers {
		cron('H H(0-1) * * *')
	}
	*/

	stages {

		// *
		// * ************************************************************DevCI TRIGGER
		// *
		stage('Vars') {
			steps {
				echo "TIER:          ${params.TIER}"
				echo "WEB_ROOT:      ${env.WEB_ROOT}"
				echo "ROOT_URL:      ${env.ROOT_URL}"
				echo "BRANCH_NAME:   ${env.BRANCH_NAME}"
				echo "BUILD_NUMBER:  ${env.BUILD_NUMBER}"
				echo "WORKSPACE:     ${WORKSPACE}"
				echo "SONARINSTANCE: ${env.SONARINSTANCE}"
				echo "SERVER:        ${env.SERVER}/${params.SERVER}"
				echo "REPO_NAME:     ${env.REPO_NAME}"
				echo "DOCS_SOURCE:   ${env.DOCS_SOURCE}"
				echo "DOCS_TARGET:   ${env.DOCS_TARGET}"
			} // end steps
		} // end DevCI Trigger

		stage('Check') {
			parallel {

				/*-----------------------------------------------------------------------------
				 * cppcheck
				 *-----------------------------------------------------------------------------
				 */
				stage('CPP') {
					agent {
						node {
							label 'epelinux3'
						}
					}
					steps {
						echo "cppcheck"
						script {
							def result = sh(
								script: '''
									cd ./
									export PATH=/opt/sofit/cppcheck/1.76.1/bin:$PATH
									mkdir -p build
									/opt/sofit/cppcheck/1.76.1/bin/cppcheck -v --enable=all --xml-version=2 -I src test 2> build/cppcheck-report.xml
								''',
								returnStdout: true
							).trim()
							echo "$result"
						}
					} // end steps
				} // end cppcheck

				/*-----------------------------------------------------------------------------
				* unit test
				*-----------------------------------------------------------------------------
				*/
				stage('unit test') {
					steps {
						echo "unit test"
						//sh ("export DOXY_BIN_PATH=/usr/local/bin/;cd ${env.WORKSPACE}/docs;/usr/bin/make html")
					}
				}

			} // parallel
		} // end stage

		stage('Artifactory') {
			parallel {

				/*-----------------------------------------------------------------------------
				 * Arduino Linux CLI
				 *-----------------------------------------------------------------------------
				 */
				stage('Arduino') {
					stages('ino') {

						stage('Arduino CLI') {
							agent {
								node {
									label 'epelinux1'
								}
							}
							when { expression { return fileExists ('${linuxTools}/${inoCLI}/arduino-cli') } }
							steps {
								rtDownload (
									serverId: artifactoryServer,
									spec: """
										{
											"files": [
														{
															"pattern": "${artifactoryRepo}/${inoCLI}/${inoTGZ}",
															"target": "${linuxTools}/",
															"explode": "true"
														}
													]
										}
									"""
								)
								sh ("chmod 750 ${linuxTools}/${inoCLI}/arduino-cli")
							}
						}

						stage('Board package') {
							when { expression { return fileExists ('~/.arduino15/library-index.json') } }
							steps {
								rtDownload (
									serverId: artifactoryServer,
									spec: """
										{
											"files": [
														{
															"pattern": "${artifactoryRepo}/${inoBoard}",
															"target": "/home/xfpjenki/",
															"flat": "true"
														}
													]
										}
									"""
								)
								sh(
									script: '''
										cd /home/xfpjenki
										tar -xf '''+brdTGZ+'''
										rm '''+brdTGZ+'''
										shopt -s globstar;
										chmod u+x /home/xfpjenki/.arduino15/**/*.sh;
										chmod u+x /home/xfpjenki/.arduino15/**/bin/*;
										find /home/xfpjenki/.arduino15/packages/arduino/tools/avr-gcc/7.3.0-atmel3.6.1-arduino7/libexec -type f -exec chmod u+x {} ";"
									''',
									returnStdout: true
								)
							}
						}

					} // end stages
				} // end stage

				/*-----------------------------------------------------------------------------
				 * Modus Toolbox
				 *-----------------------------------------------------------------------------
				 */
				stage('MTB') {
					stages('ModusToolbox') {

						stage('MTB setup') {
							// agent {
							// 	node {
							// 		label 'epewin'
							// 	}
							// }
							// //when { expression { return fileExists ('./.arduino15/library-index.json') } }
							// steps {
							// 	echo "MTP setup"
							// }

							agent {
								node {
									label 'epelinux3'
								}
							}
							when { expression { return fileExists ('${linuxTools}/${mtbmake}') } }
							steps {
								rtDownload (
									serverId: artifactoryServer,
									spec: """
										{
											"files": [
														{
															"pattern": "${artifactoryRepo}/${mtbTools}/${mtbTtgz}",
															"target": "${linuxTools}/",
															"explode": "true"
														}
													]
										}
									"""
								)
								sh(
									script: '''
										cd /home/xfpjenki/tools
										tar -xf '''+brdTtgz+'''
										rm '''+brdTtgz+'''
									''',
									returnStdout: true
								)
							}
						}

					} // end stages
				} // end stage

				/*-----------------------------------------------------------------------------
				 * WiCED Toolbox
				 *-----------------------------------------------------------------------------
				 */
				stage('WiCED') {
					stages('wcd') {

						stage('WiCED setup') {
							agent {
								node {
									label 'epewin'
								}
							}
							//when { expression { return fileExists ('./.arduino15/library-index.json') } }
							steps {
								echo "WiCED setup"
							}
						}

					} // end stages
				} // end stage


				/*-----------------------------------------------------------------------------
				 * Raspberry PI
				 *-----------------------------------------------------------------------------
				 */
				stage('RPi') {
					stages('RaspberryPi') {

						stage('RPi setup') {
							agent {
								node {
									label 'epewin'
								}
							}
							//when { expression { return fileExists ('./.arduino15/library-index.json') } }
							steps {
								echo "RPi setup"
							}
						}

					} // end stages
				} // end stage

			} // end parallel
		} // end stage

		stage('build') {
			parallel {

				/*-----------------------------------------------------------------------------
				 * Arduino Linux CLI
				 *-----------------------------------------------------------------------------
				 */
				stage('Arduino Linux') {
					agent {
						node {
							label 'epelinux'
						}
					}

					stages('Arduino') {

						stage('Generate INO') {
							steps {
								echo "xfp-dev"
								sh(
									script: '''
										cd ./
										export PATH=/opt/python/3.9/linux/RHEL60/bin:$PATH
										export PYTHONPATH=/opt/python/3.9/linux//RHEL60//../pyperl/python/lib/python3.9/site-packages:/home/xfpjenki/tools/python3
										rm -rf ./build/Arduino
										mkdir -p ./build/Arduino
										'''+linuxTools+'''/python3/bin/xfp-dev arduino lib-pack --path=./build/Arduino
									''',
									returnStdout: true
								)
							} // end xfp-dev
						}

						stage('CLI Build') {
							steps {
								echo "Compile"
								script {
									def result = sh(
										script: '''
											cd ./
											export lib=`ls -1 ./build/Arduino/`
											export examples=(`ls -1 ./build/Arduino/${lib}/examples/`)
											echo $examples
											for i in "${examples[@]}"
											do
												echo $i;
												'''+linuxTools+'''/'''+inoCLI+'''/arduino-cli compile --verbose --fqbn arduino:avr:uno --libraries=./build/Arduino/${lib} build/Arduino/${lib}/examples/$i
											done
										''',
										returnStdout: true
									).trim()
									echo "$result"
								}
							} // end CLI Build
						}

					}

				}

				// /*-----------------------------------------------------------------------------
				//  * PlatformIO build
				//  *-----------------------------------------------------------------------------
				//  */
				// stage('PIO') {
				// 	steps {
				// 		echo "PlatformIO"
				// 		/*
				// 		sh ("export DOXY_BIN_PATH=/usr/local/bin/;cd ${env.WORKSPACE}/docs;/usr/bin/make pdf")
				// 		build(
				// 			job: 'dev/doxy_maker_pdf',
				// 			propagate: true,
				// 			parameters: [
				// 				[
				// 					$class: 'StringParameterValue',
				// 					name: 'WORKSPACE',
				// 					value: "${env.WORKSPACE}"
				// 				],
				// 			]
				// 		)
				// 		*/
				// 	}
				// }

				/*-----------------------------------------------------------------------------
				 * doxygen
				 *-----------------------------------------------------------------------------
				 */
				stage('docu') {
					agent {
						node {
							label 'epelinux2'
						}
					}

					stages {

						stage('doxygen') {
							steps {
								echo "doxygen"
								script {
									def result = sh(
										script: '''
											cd ./
											export DOCS_SOURCE=${WORKSPACE}/docs/doxygen/build
											export PATH=/opt/doxygen/1.8.14/bin:/opt/python/anaconda/4.2.0/py3.5.2:$PATH
											rm -rf infineondoxygenerator
											git clone https://bitbucket.vih.infineon.com/scm/ghmm/infineondoxygenerator.git;
											cd ./infineondoxygenerator;
											python3 doxyifx.py html
											rm -rf ${DOCS_TARGET}
											mkdir -p ${DOCS_TARGET}
											cp -R ${DOCS_SOURCE}/ ${DOCS_TARGET}/.
										''',
										returnStdout: true
									).trim()
									echo "$result"
								}
							} // end doxygen
						} // end stage

						stage('Sphinx') {
							when { expression { return fileExists ('./docs/config.py') } }
							steps {
								echo "ReadTheDocs"
								script {
									def result = sh(
										script: '''
											export PATH=/opt/python/3.9/linux/RHEL60/bin:$PATH
											cd docs
											sphinx-build ./ ./documentation
											rm -rf ${DOCS_TARGET}
											mkdir -p ${DOCS_TARGET}
											cp -R ./documentation ${DOCS_TARGET}/.
										''',
										returnStdout: true
									).trim()
									echo "$result"
								}

							} // end ReadTheDocs
						} // end sphinx

					 } // end stages

				} // end docu

			} // end parallel
		} // end docu build

		/*-----------------------------------------------------------------------------
		 * SonarQube stage runs the sonar scanner and collects all reports
		 *-----------------------------------------------------------------------------
		 */
		stage('SonarQube') {
			steps {
				echo "SonarQube"
				catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
					withSonarQubeEnv(
						installationName: "${params.SONARINSTANCE}"
					){
						script {
							if (isUnix()) {
								env.scannerHome = tool 'sonar-scanner-cli-4.2.0.1873-linux'
							}else{
								env.scannerHome = tool 'sonar-scanner-4.2.0.1873'
							}
							def result = sh(
								script: '''
									cp ./devops/xfpbuild/sonar-project.properties ./.;
									${scannerHome}/bin/sonar-scanner -X
								''',
								returnStdout: true
							).trim()
							echo "$result"
						}
					}
				} // end catch
				catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
					timeout(time: 200, unit: 'MINUTES') {
						waitForQualityGate abortPipeline: true
					}
				} // end catch
			} // end steps

		} // end SonarQube

	} // end stages

	/*-----------------------------------------------------------------------------
	 * post
	 *-----------------------------------------------------------------------------
	 */
	
	post {
		failure {
			
			mail(
				to: 'Olaf.Filies@infineon.com',
				subject: "[EPE JENKINS] pipeline: ${env.BRANCH_NAME}",
				body: "Something during Jenkins pipeline run went wrong."
			)
			
		}
	}

}
